<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <title>檔案託管服務</title>

    <!-- 防止主題閃爍：在任何樣式載入前設定主題 -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/main.css">
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- 頂部資訊列 -->
    <nav class="navbar navbar-expand-lg shadow-sm" id="main-navbar">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-cloud-upload-fill me-2"></i>
                <span class="fw-bold">檔案託管</span>
            </a>

            <div class="d-flex align-items-center gap-2">
                <!-- 使用者資訊區（已登入時顯示） -->
                <div id="navbar-user-info" class="d-none">
                    <div class="d-flex align-items-center gap-2">
                        <img id="navbar-user-avatar" class="rounded-circle" src="" alt="User Avatar" width="32"
                            height="32">
                        <div class="user-info-text d-none d-md-block">
                            <div class="small fw-bold" id="navbar-user-name"></div>
                            <div class="small opacity-75" id="navbar-user-login" style="font-size: 0.75rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- 主題切換按鈕 -->
                <button id="theme-toggle-btn" class="btn btn-sm btn-outline-secondary" title="切換主題">
                    <i id="theme-icon" class="bi bi-moon-fill"></i>
                </button>

                <!-- 登出按鈕（已登入時顯示） -->
                <button id="navbar-logout-btn" class="btn btn-sm btn-outline-secondary d-none" title="登出">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4 px-4 flex-grow-1">
        <div class="card shadow-lg border-0">
            <div class="card-body p-4 p-md-5">
                <!-- Header -->
                <div id="page-header" class="text-center mb-4">
                    <h1 class="display-5 fw-bold">
                        <i class="bi bi-cloud-upload-fill me-2"></i>
                        檔案託管
                    </h1>
                    <p class="text-muted">使用 Personal Access Token 登入並管理你的檔案</p>
                </div>

                <!-- 登入區段 -->
                <div id="login-section">
                    <div class="text-center">
                        <button id="login-btn" class="btn btn-primary btn-lg">
                            <i class="bi bi-github me-2"></i>
                            使用 GitHub Personal Access Token 登入
                        </button>
                    </div>

                    <div id="token-input-section" class="d-none mt-4">
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>如何取得 Personal Access Token：
                            </h6>
                            <ol class="mb-0 small">
                                <li>前往 <a href="https://github.com/settings/tokens/new" target="_blank"
                                        class="alert-link">GitHub Token 設定頁面</a></li>
                                <li>設定 Token 名稱（例如：File Hosting）</li>
                                <li>選擇 Expiration（建議選擇較短的期限）</li>
                                <li>勾選 <code>repo</code> 權限（完整存取權限）</li>
                                <li>點擊「Generate token」並複製產生的 token</li>
                            </ol>
                        </div>
                        <div class="input-group">
                            <input type="password" id="token-input" class="form-control form-control-lg"
                                placeholder="貼上你的 GitHub Personal Access Token">
                            <button id="token-login-btn" class="btn btn-success btn-lg">
                                <i class="bi bi-box-arrow-in-right me-2"></i>登入
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 已登入區段 -->
                <div id="authenticated-section" class="d-none">
                    <!-- 視圖 1: 分類管理頁面 -->
                    <div id="folder-management-view">
                        <div class="row">
                            <!-- 左側：建立分類 -->
                            <div class="col-lg-4">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-folder-plus me-2"></i>建立分類</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="input-group">
                                            <input type="text" id="new-folder-input" class="form-control"
                                                placeholder="輸入分類名稱">
                                            <button id="create-folder-btn" class="btn btn-success">
                                                <i class="bi bi-plus-circle me-2"></i>建立分類
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 右側：分類列表 -->
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between">
                                        <h5 class="mb-0"><i class="bi bi-folder-fill me-2"></i>現有分類</h5>
                                        <button id="refresh-folders-btn" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-arrow-clockwise me-1"></i>重新整理
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="input-group mb-3">
                                            <input type="text" id="filter-folder-input" class="form-control" placeholder="輸入分類名稱以過濾列表">
                                            <button id="clear-filter-folder-btn" class="btn btn-secondary" type="button" title="清除過濾">
                                                <i class="bi bi-x-lg me-2"></i>清除
                                            </button>
                                        </div>
                                        <div id="folders-list" class="list-group list-group-flush">
                                            <div class="text-center text-muted py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">載入中...</span>
                                                </div>
                                                <p class="mt-2">載入分類列表...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 視圖 2: 檔案管理頁面 -->
                    <div id="file-management-view" class="d-none">
                        <div class="row">
                            <!-- 左側：上傳檔案 -->
                            <div class="col-lg-4">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <div>
                                            <h5 class="mb-0">
                                                <i class="bi bi-upload me-2"></i>上傳檔案
                                            </h5>
                                            <div class="mt-1 small text-muted">
                                                <i class="bi bi-folder2-open me-1"></i>
                                                <code id="current-folder-name" class="text-primary text-break"></code>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="drop-zone"
                                            class="drop-zone text-center p-5 border border-2 border-dashed rounded">
                                            <i class="bi bi-cloud-upload display-1 text-muted mb-3"></i>
                                            <p class="mb-2">將檔案拖曳到此處</p>
                                            <p class="text-muted small mb-3">或</p>
                                            <input type="file" id="file-input" class="d-none" multiple>
                                            <button id="select-files-btn" class="btn btn-outline-primary">
                                                <i class="bi bi-file-earmark-plus me-2"></i>選擇檔案
                                            </button>
                                        </div>

                                        <!-- 上傳進度 -->
                                        <div id="upload-progress" class="d-none mt-3">
                                            <div class="progress" style="height: 25px;">
                                                <div id="progress-bar"
                                                    class="progress-bar progress-bar-striped progress-bar-animated"
                                                    role="progressbar" style="width: 0%">0%</div>
                                            </div>
                                            <div id="upload-status" class="text-center mt-2 small text-muted"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 右側：檔案列表 -->
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between">
                                        <div>
                                            <h5 class="mb-0">
                                                <i class="bi bi-files me-2"></i>
                                                檔案列表
                                            </h5>
                                            <div class="mt-1 small text-muted">
                                                <i class="bi bi-folder2-open me-1"></i>
                                                <code id="current-folder-name-header" class="text-primary text-break"></code>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <button id="back-to-folders-btn" class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-arrow-left me-1"></i>返回
                                            </button>
                                            <button id="refresh-files-btn" class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-arrow-clockwise me-1"></i>重新整理
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="file-list" class="list-group list-group-flush">
                                            <div class="text-center text-muted py-4">
                                                <i class="bi bi-folder2-open display-4"></i>
                                                <p class="mt-2">載入檔案列表...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer mt-auto py-3">
        <div class="container-fluid text-center small">
            <div class="d-flex flex-column flex-sm-row align-items-center justify-content-center gap-2">
                <span>© <span id="current-year"></span></span>
                <span class="d-none d-sm-inline">·</span>
                <span>Made with ❤️ by PoyChang</span>
                <span class="d-none d-sm-inline">·</span>
                <a href="https://github.com/poychang/files.poychang.net" target="_blank" rel="noopener">
                    Hosting on GitHub <i class="bi bi-github me-1"></i>
                </a>
                <span class="d-none d-sm-inline">·</span>
                <a href="https://blog.poychang.net" target="_blank" rel="noopener">
                    <i class="bi bi-house-door me-1"></i>Blog
                </a>
            </div>
        </div>
    </footer>

    <!-- Toast 通知容器 - 調整位置避免被導航列遮擋 -->
    <div class="toast-container position-fixed end-0 p-3" style="top: 70px; z-index: 9999;">
        <div id="message-toast" class="toast align-items-center border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i id="toast-icon" class="me-2"></i>
                    <span id="toast-message"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- 刪除分類確認 Modal -->
    <div class="modal fade" id="deleteFolderModal" tabindex="-1" aria-labelledby="deleteFolderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="deleteFolderModalLabel">
                        <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
                        確認刪除分類
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">確定要刪除分類 <strong id="folder-to-delete-name" class="text-danger"></strong> 嗎？</p>
                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        此操作將刪除該分類及其下的所有檔案，且<strong>無法復原</strong>。
                    </p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-folder-btn">
                        <i class="bi bi-trash me-1"></i>確認刪除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 上傳檔案確認 Modal -->
    <div class="modal fade" id="uploadConfirmModal" tabindex="-1" aria-labelledby="uploadConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="uploadConfirmModalLabel">
                        <i class="bi bi-cloud-upload-fill text-primary me-2"></i>
                        確認上傳檔案
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">確定要上傳 <strong id="upload-file-count" class="text-primary"></strong> 個檔案到以下路徑嗎？</p>
                    <p class="mb-2">
                        <code id="upload-target-path" class="text-primary"></code>
                    </p>
                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        如果檔案名稱已存在，將會覆蓋原有檔案。
                    </p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-upload-btn">
                        <i class="bi bi-cloud-upload me-1"></i>確認上傳
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 載入設定檔 -->
    <script src="js/config.js"></script>

    <!-- Footer year init -->
    <script>
        (function(){
            var y = new Date().getFullYear();
            var el = document.getElementById('current-year');
            if (el) el.textContent = y;
        })();
    </script>

    <!-- 主要應用程式邏輯 -->
    <script type="module" src="js/app.js"></script>
</body>

</html>